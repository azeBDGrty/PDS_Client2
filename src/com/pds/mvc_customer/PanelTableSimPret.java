/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.pds.mvc_customer;

import com.pds.entities.Client;
import com.pds.entities.MathHepler;
import com.pds.entities.SimulationPret;
import com.pds.implobs.AbstractObservable;
import com.pds.mvc_customer.Controller_GestClient;
import java.sql.Timestamp;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Vector;
import java.util.function.Consumer;
import javax.swing.ListSelectionModel;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author zouhairhajji
 */
public class PanelTableSimPret extends javax.swing.JInternalFrame implements com.pds.implobs.IObserver {

    private Client client;
    private List<SimulationPret> listSimPretConcerned;
    private Controller_GestClient controller;
    private double coefs[];
    private int selectedIndex;
    
    /**
     * Creates new form PanelTableSimPret
     */
    

    PanelTableSimPret(Controller_GestClient controller) {
        this.controller = controller;
        this.coefs = new double[]{7, 6, 5, 4, 3, 2, 1};
        this.selectedIndex = -1;
        initComponents();
        this.afficherSimulation.setEnabled(false);
        this.jTable1.getSelectionModel().addListSelectionListener(new TableSelecterListener());
        
        
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jScrollPane1 = new javax.swing.JScrollPane();
        jTable1 = new javax.swing.JTable();
        jLabel1 = new javax.swing.JLabel();
        afficherSimulation = new javax.swing.JButton();
        jPanel1 = new javax.swing.JPanel();

        setClosable(true);
        setIconifiable(true);

        jTable1.setFont(new java.awt.Font("Lucida Grande", 0, 14)); // NOI18N
        jTable1.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {
                    ""

                }},
                new String [] {
                    "Identifiant de la simulation", "Mensualité", "Durée", "Taux d'interet", "Montant totale", "Type de prêt", "Taux d'endettement", "Date fin du contrat", "Resultat", "Position"
                }
            ));
            jScrollPane1.setViewportView(jTable1);

            jLabel1.setFont(new java.awt.Font("Lucida Grande", 0, 36)); // NOI18N
            jLabel1.setText("Le tri intéligent des simulations");

            afficherSimulation.setText("Afficher les simulations");
            afficherSimulation.addActionListener(new java.awt.event.ActionListener() {
                public void actionPerformed(java.awt.event.ActionEvent evt) {
                    afficherSimulationActionPerformed(evt);
                }
            });

            jPanel1.setBorder(javax.swing.BorderFactory.createEtchedBorder());

            javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
            jPanel1.setLayout(jPanel1Layout);
            jPanel1Layout.setHorizontalGroup(
                jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGap(0, 777, Short.MAX_VALUE)
            );
            jPanel1Layout.setVerticalGroup(
                jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGap(0, 225, Short.MAX_VALUE)
            );

            javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
            getContentPane().setLayout(layout);
            layout.setHorizontalGroup(
                layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGroup(layout.createSequentialGroup()
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                        .addGroup(layout.createSequentialGroup()
                            .addContainerGap()
                            .addComponent(jScrollPane1))
                        .addGroup(layout.createSequentialGroup()
                            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                .addGroup(layout.createSequentialGroup()
                                    .addGap(266, 266, 266)
                                    .addComponent(jLabel1))
                                .addGroup(layout.createSequentialGroup()
                                    .addContainerGap()
                                    .addComponent(afficherSimulation)))
                            .addGap(0, 337, Short.MAX_VALUE)))
                    .addContainerGap())
                .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                    .addGap(0, 0, Short.MAX_VALUE)
                    .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGap(152, 152, 152))
            );
            layout.setVerticalGroup(
                layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                .addGroup(layout.createSequentialGroup()
                    .addGap(22, 22, 22)
                    .addComponent(jLabel1)
                    .addGap(32, 32, 32)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 195, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                    .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 63, Short.MAX_VALUE)
                    .addComponent(afficherSimulation, javax.swing.GroupLayout.PREFERRED_SIZE, 41, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addContainerGap())
            );

            pack();
        }// </editor-fold>//GEN-END:initComponents

    private void afficherSimulationActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_afficherSimulationActionPerformed
        System.out.println(this.listSimPretConcerned.get(this.selectedIndex));
    }//GEN-LAST:event_afficherSimulationActionPerformed


    
    void chargerSimulations(Client client, List<SimulationPret> listSimPret) throws CloneNotSupportedException {
        this.client = client;
        this.listSimPretConcerned = listSimPret;
        DefaultTableModel tableModel = (DefaultTableModel) jTable1.getModel();
        tableModel.setRowCount(0);
        /*
        listSimPret.stream()
                .sorted(
                        (e1, e2) -> MathHepler.compareToWithTauxEndet(client, e1, e2, true)
                                //Double.compare(
                                //e1.getTauxEndettement(client), e2.getTauxEndettement(client))
                )
                .forEach(e -> listSimPretConcerned.add(e));
        */
        
        int pMensualite = -1;
        int pDuree = -1;
        int pTauxInteret = -1;
        int pMtTotal = -1;
        int pTypePret = -1;
        int pTauxEndettement = -1;
        int pDateFin = -1;
        double resultat = -1;
        int position = 0;
        
        List<Object[]> dataSimulations = new LinkedList<>();
        for(int i = 0; i<listSimPret.size() ;i++){         
            pMensualite = getPosMensualite(listSimPret, listSimPret.get(i));
            pDuree = getPosDuree(listSimPret, listSimPret.get(i));
            pTauxInteret = getPosTauxInteret(listSimPret, listSimPret.get(i));
            pMtTotal = getPosMensualite(listSimPret, listSimPret.get(i)) ;
            pTypePret = getPosTypePret(listSimPret, listSimPret.get(i)) ;
            pTauxEndettement = getPosTauxEndett(listSimPret, listSimPret.get(i)); 
            pDateFin = getPosDateFin(listSimPret, listSimPret.get(i)); 
            resultat =   getResultat(pMensualite, pDuree, pTauxInteret, pMtTotal, pTypePret, pTauxEndettement, pDateFin);
            
            Object[] objects = new Object[]{
                "Idenfiant :"+listSimPret.get(i).getIdSimPret(),
                MathHepler.ajustVirgule(listSimPret.get(i).getMensualite(), 2)+ " €",
                listSimPret.get(i).getDureePret()+ " mois",
                MathHepler.ajustVirgule(listSimPret.get(i).getTauxInteret(), 2)+" %",
                MathHepler.ajustVirgule(listSimPret.get(i).getMensualite()*listSimPret.get(i).getDureePret(), 2)+ " €",
                listSimPret.get(i).getTypePret().getAbv(),
                MathHepler.ajustVirgule(listSimPret.get(i).getTauxEndettement(client)*100, 2)+" %",
                MathHepler.addMouthToDate(listSimPret.get(i).getDateContraction(), listSimPret.get(i).getDureePret()),
                resultat, 
                -1
            };
            dataSimulations.add(objects); 
        }
        
        Collections.sort(dataSimulations, new Comparator<Object[]>(){
            @Override
            public int compare(Object[] o1, Object[] o2) {
                return MathHepler.compareToResSimulation(o1, o2, true);
            }
        });
        
        for(int i = 0; i<dataSimulations.size() ;i++){
            System.out.println((Timestamp)dataSimulations.get(i)[7]);
            dataSimulations.get(i)[7] = MathHepler.formatTimeStamp((Timestamp)dataSimulations.get(i)[7], "dd-MM-yyyy");
            dataSimulations.get(i)[9] = (i+1);
            tableModel.addRow(dataSimulations.get(i));
        }
        
        
        
        /*
        Object[] objects = new Object[]{
                "Idenfiant :"+simulation.getIdSimPret(),
                MathHepler.ajustVirgule(simulation.getMensualite(), 2)+ " €",
                simulation.getDureePret()+ " mois",
                MathHepler.ajustVirgule(simulation.getTauxInteret(), 2)+" %",
                MathHepler.ajustVirgule(simulation.getMensualite()*simulation.getDureePret(), 2)+ " €",
                simulation.getTypePret().getAbv(),
                MathHepler.ajustVirgule(simulation.getTauxEndettement(client)*100, 2)+" %",
                MathHepler.ajustVirgule(resultat, 2)+" points"
            };
            tableModel.addRow(objects);
         */
        
            
        this.repaint();
        this.validate();
    }
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton afficherSimulation;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTable jTable1;
    // End of variables declaration//GEN-END:variables


    public  double getResultat(double pMensualite, double pDuree, double pTauxInteret, double pMtTotal, double pTypePret, double pTauxEndettement, double pDateFin){
        return (pMensualite * coefs[0] + pDuree* coefs[1] + pTauxInteret* coefs[2] + pMtTotal* coefs[3] + pTypePret* coefs[4]+ pTauxEndettement* coefs[5]+ pDateFin* coefs[6]);
    }
    
    
    
    public int getPosMensualite(List<SimulationPret> listSimulation, SimulationPret simulationConcerned){
        int position = 1;
        List<SimulationPret> simulations = new LinkedList<>();
        
        listSimulation.stream()
                .sorted(
                        (e1, e2) -> MathHepler.compareToWithMensualite(e1, e2, false)
                ).forEach(e -> simulations.add(e));
        
        return simulations.indexOf(simulationConcerned);
    }
    
    
    public int getPosDuree(List<SimulationPret> listSimulation, SimulationPret simulationConcerned){
        int position = 1;
        List<SimulationPret> simulations = new LinkedList<>();
        
        listSimulation.stream()
                .sorted(
                        (e1, e2) -> MathHepler.compareToWithDuree(e1, e2, false)
                ).forEach(e -> simulations.add(e));
        
        return simulations.indexOf(simulationConcerned);
    }
    
    
    public int getPosTauxInteret(List<SimulationPret> listSimulation, SimulationPret simulationConcerned){
        int position = 1;
        List<SimulationPret> simulations = new LinkedList<>();
        
        listSimulation.stream()
                .sorted(
                        (e1, e2) -> MathHepler.compareToInteret(e1, e2, false)
                ).forEach(e -> simulations.add(e));
        
        return simulations.indexOf(simulationConcerned);
    }
    
    
    public int getPosMtTotal(List<SimulationPret> listSimulation, SimulationPret simulationConcerned){
        int position = 1;
        List<SimulationPret> simulations = new LinkedList<>();
        
        listSimulation.stream()
                .sorted(
                        (e1, e2) -> MathHepler.compareToMtTotale(e1, e2, false)
                ).forEach(e -> simulations.add(e));
        
        return simulations.indexOf(simulationConcerned);
    }
    
    
    public int getPosTypePret(List<SimulationPret> listSimulation, SimulationPret simulationConcerned){
        int position = 1;
        List<SimulationPret> simulations = new LinkedList<>();
        
        listSimulation.stream()
                .sorted(
                        (e1, e2) -> MathHepler.compareToTypePret(e1, e2, false)
                ).forEach(e -> simulations.add(e));
        
        return simulations.indexOf(simulationConcerned);
    }
    
    
    public int getPosTauxEndett(List<SimulationPret> listSimulation, SimulationPret simulationConcerned){
        int position = 1;
        List<SimulationPret> simulations = new LinkedList<>();
        
        listSimulation.stream()
                .sorted(
                        (e1, e2) -> MathHepler.compareToWithTauxEndet(client, e1, e2, false)
                ).forEach(e -> simulations.add(e));
        
        return simulations.indexOf(simulationConcerned);
    }
    
    public int getPosResSimPret (List<Object[]> listSimulation, SimulationPret simulationConcerned){
        int position = 1;
        List<Object[]> simulations = new LinkedList<>();
        
        listSimulation.stream()
                .sorted(
                        (e1, e2) -> MathHepler.compareToResSimulation( e1, e2, false)
                ).forEach(e -> simulations.add(e));
        
        return simulations.indexOf(simulationConcerned);
    }
    
    public int getPosDateFin(List<SimulationPret> listSimulation, SimulationPret simulationConcerned){
        int position = 1;
        List<SimulationPret> simulations = new LinkedList<>();
        
        listSimulation.stream()
                .sorted(
                        (e1, e2) -> MathHepler.compareToDateFin( e1, e2, false)
                ).forEach(e -> simulations.add(e));
        
        return simulations.indexOf(simulationConcerned);
    }
    
    @Override
    public boolean update(AbstractObservable sender, String message, Object... data) {
        return true;
    }

    
    
    
    
    
    public class TableSelecterListener implements ListSelectionListener {
        @Override
        public void valueChanged(ListSelectionEvent e) {
            if (!e.getValueIsAdjusting()) {
                if (!((ListSelectionModel) e.getSource()).isSelectionEmpty()) {
                    selectedIndex = ((ListSelectionModel) e.getSource()).getMinSelectionIndex();
                    afficherSimulation.setEnabled(true);
                }else{
                    selectedIndex = -1;
                    afficherSimulation.setEnabled(false);
                }   
            }
                 
        }
    }
    
    
}
